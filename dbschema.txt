// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

// általános beállítások
datasource db {
  provider  = "postgresql"
  url       = env("DIRECT_URL")
  directUrl = env("DIRECT_URL")
}

// migrációhoz szükséges beállítások
// datasource db {
//  provider = "postgresql"
//  directUrl = env("DIRECT_URL")
//  url       = env("DATABASE_URL")    
// }

// ---------------------------------------------------------
// ENUMS
// ---------------------------------------------------------

enum Role {
  STUDENT
  COMPANY_ADMIN
  MENTOR
  UNIVERSITY_USER
  SYSTEM_ADMIN
}

enum ApplicationStatus {
  SUBMITTED
  ACCEPTED
  REJECTED
  NO_RESPONSE
}

enum LogStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum DocumentType {
  CV
  MOTIVATION
  LANGUAGE_CERT
  DIPLOMA
  SCHOOL_CERT
  LOG_EXPORT
  PPT
  OTHER
}

enum PartnershipStatus {
  ACTIVE
  FINISHED
  TERMINATED
}

// ---------------------------------------------------------
// FELHASZNÁLÓK ÉS PROFILOK
// ---------------------------------------------------------

model User {
  id          String @id @default(uuid())
  email       String @unique
  password    String
  fullName    String
  phoneNumber String
  role        Role

  isActive Boolean @default(true)

  passwordResetToken String?
  tokenExpiry        DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Kapcsolatok
  studentProfile  StudentProfile?
  companyEmployee CompanyEmployee?

  uniPartnerships DualPartnership[]

  notifications Notification[]
  auditLogs     AuditLog[]

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

model StudentProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  mothersName String
  birthDate   DateTime

  country       String? @default("Magyarország")
  zipCode       String?
  city          String?
  streetAddress String?

  highSchool      String
  graduationYear  Int
  neptunCode      String?
  currentMajor    String
  studyMode       String
  hasLanguageCert Boolean @default(false)

  deletedAt DateTime?

  documents    Document[]
  applications Application[]
  partnerships DualPartnership[]
}

model CompanyEmployee {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  jobTitle  String?
  deletedAt DateTime?

  mentoredPartnerships DualPartnership[]
}

// ---------------------------------------------------------
// CÉGEK ÉS POZÍCIÓK
// ---------------------------------------------------------

model Company {
  id String @id @default(uuid())

  name  String
  taxId String @unique

  description String?

  hqCountry String @default("Magyarország")
  hqZipCode String
  hqCity    String
  hqAddress String

  contactName  String
  contactEmail String
  website      String?
  logoUrl      String?

  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  employees CompanyEmployee[]
  positions Position[]
}

model Position {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  title       String
  description String?

  isDual Boolean @default(false)

  zipCode String
  city    String
  address String

  tags Tag[]

  deadline DateTime?

  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  applications Application[]
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  category  String    @default("Technology")
  deletedAt DateTime?

  positions Position[]
}

// ---------------------------------------------------------
// JELENTKEZÉS ÉS KÉPZÉS FOLYAMATA
// ---------------------------------------------------------

model Application {
  id String @id @default(uuid())

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  positionId String
  position   Position @relation(fields: [positionId], references: [id])

  status ApplicationStatus @default(SUBMITTED)

  companyNote String?
  studentNote String?

  submittedAt DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@unique([studentId, positionId])
}

model DualPartnership {
  id String @id @default(uuid())

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  mentorId String?
  mentor   CompanyEmployee? @relation(fields: [mentorId], references: [id])

  uniEmployeeId String?
  uniEmployee   User?   @relation(fields: [uniEmployeeId], references: [id])

  semester       String
  contractNumber String?

  status    PartnershipStatus @default(ACTIVE)
  startDate DateTime
  endDate   DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  logbookEntries LogbookEntry[]
}

// ---------------------------------------------------------
// DOKUMENTUMOK ÉS NAPLÓ
// ---------------------------------------------------------

model Document {
  id String @id @default(uuid())

  ownerId String
  student StudentProfile @relation(fields: [ownerId], references: [id])

  type         DocumentType
  filePath     String
  originalName String
  mimeType     String?

  uploadedAt DateTime  @default(now())
  deletedAt  DateTime?
}

model LogbookEntry {
  id String @id @default(uuid())

  partnershipId String
  partnership   DualPartnership @relation(fields: [partnershipId], references: [id])

  date     DateTime
  activity String

  status        LogStatus @default(DRAFT)
  rejectionNote String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

// ---------------------------------------------------------
// RENDSZER ÉS BIZTONSÁG
// ---------------------------------------------------------

model Notification {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  title     String
  message   String
  type      String
  createdAt DateTime @default(now())
}

model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action   String
  entity   String
  entityId String?
  details  Json?

  timestamp DateTime @default(now())
}

model Message {
  id String @id @default(uuid())

  // JAVÍTVA: Kapcsolatok a User táblával (Sender/Receiver)
  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id])

  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])

  subject String?
  content String
  sentAt  DateTime @default(now())
}
